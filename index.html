<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>An치lisis de Inventario - SEVENTEEN PER칔</title>
    <link rel="icon" type="image/png" href="logo.png" />
    <meta
      name="description"
      content="Dashboard de an치lisis inteligente de inventario"
    />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                50: "#f0f9ff",
                100: "#e0f2fe",
                200: "#bae6fd",
                300: "#7dd3fc",
                400: "#38bdf8",
                500: "#0c4a6e",
                600: "#0c4a6e",
                700: "#0c4a6e",
                800: "#075985",
                900: "#0c4a6e",
              },
            },
          },
        },
      };
    </script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- FontAwesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />

    <!-- Custom Styles (DRY - extracted) -->
    <link rel="stylesheet" href="styles.css" />

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap");

      * {
        font-family: "Inter", sans-serif;
      }

      /* Sticky footer layout */
      body {
        background: #f8fafc;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      main {
        flex: 1;
      }

      /* Reusable card component */
      .card {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 0.75rem;
        padding: 1.25rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
      }

      /* Header bar */
      .header-bar {
        background: #ffffff;
        border-bottom: 1px solid #e2e8f0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.03);
      }

      /* Status bar */
      .status-bar {
        height: 6px;
        border-radius: 3px;
      }

      /* Scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f5f9;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }

      /* Loader */
      .loader {
        border: 3px solid #e2e8f0;
        border-top-color: #0c4a6e;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Pagination */
      .pagination-btn {
        padding: 0.375rem 0.75rem;
        border: none;
        border-radius: 0.5rem;
        background: #f1f5f9;
        color: #475569;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
      }
      .pagination-btn:hover {
        background: #e2e8f0;
        color: #1e293b;
      }
      .pagination-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        background: #f8fafc;
      }
      .pagination-btn.active {
        background: #0c4a6e;
        color: #ffffff;
      }

      /* Upload Modal */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
      }
      .modal-content {
        background: white;
        border-radius: 0.75rem;
        padding: 2rem;
        max-width: 400px;
        width: 90%;
        text-align: center;
      }
      .progress-bar {
        height: 8px;
        background: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 1rem;
      }
      .progress-fill {
        height: 100%;
        background: #37b6fb;
        border-radius: 4px;
        transition: width 0.3s ease;
      }

      /* Section Titles */
      .section-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: #0c4a6e;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding-left: 0.75rem;
        border-left: 3px solid #0c4a6e;
        margin-bottom: 1rem;
      }

      /* Table Styling */
      .data-table {
        width: 100%;
        border-collapse: collapse;
      }
      .data-table thead {
        background: #0c4a6e;
      }
      .data-table th {
        color: white;
        font-weight: 500;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding: 0.75rem 1rem;
        text-align: left;
      }
      .data-table tbody tr {
        border-bottom: 1px solid #e2e8f0;
      }
      .data-table tbody tr:hover {
        background: #f8fafc;
      }
      .data-table td {
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
      }

      /* KPI Icon Backgrounds */
      .kpi-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .kpi-icon svg {
        width: 24px;
        height: 24px;
      }
      .kpi-icon.primary {
        background: rgba(12, 74, 110, 0.1);
        color: #0c4a6e;
      }
      .kpi-icon.success {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
      }
      .kpi-icon.info {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
      }
      .kpi-icon.warning {
        background: rgba(245, 158, 11, 0.1);
        color: #f59e0b;
      }

      /* Status Badges */
      .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
      }
      .status-badge.negative {
        background: #fef2f2;
        color: #dc2626;
      }
      .status-badge.out-of-stock {
        background: #fff7ed;
        color: #ea580c;
      }
      .status-badge.critical {
        background: #fefce8;
        color: #ca8a04;
      }
      .status-badge.low {
        background: #f0fdf4;
        color: #16a34a;
      }
      .status-badge.optimal {
        background: #ecfdf5;
        color: #059669;
      }
      .status-badge.overstock {
        background: #eff6ff;
        color: #2563eb;
      }

      /* Stock Status Cards */
      .stock-card {
        text-align: center;
        padding: 1rem;
        border-radius: 0.75rem;
        border: 1px solid #e2e8f0;
      }
      .stock-card .number {
        font-size: 1.5rem;
        font-weight: 700;
      }
      .stock-card .label {
        font-size: 0.75rem;
        margin-top: 0.25rem;
      }
      .stock-card .percent {
        font-size: 0.625rem;
        opacity: 0.7;
      }
    </style>
  </head>
  <body class="text-slate-700">
    <!-- Header (loaded from partial) -->
    <div id="header-placeholder"></div>

    <!-- Upload Progress Modal -->
    <div id="upload-modal" class="modal-overlay hidden">
      <div class="modal-content">
        <div class="loader mx-auto mb-4"></div>
        <h3 id="upload-title" class="text-lg font-semibold text-slate-700 mb-2">
          Subiendo archivo...
        </h3>
        <p id="upload-status" class="text-sm text-slate-500 mb-2">
          Preparando carga
        </p>
        <div class="progress-bar">
          <div
            id="upload-progress"
            class="progress-fill"
            style="width: 0%"
          ></div>
        </div>
        <p id="upload-percent" class="text-sm text-slate-400 mt-2">0%</p>
      </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 py-8 flex-1">
      <!-- Loading State -->
      <div
        id="loading-state"
        class="flex flex-col items-center justify-center h-[60vh]"
      >
        <div class="loader mb-4"></div>
        <p class="text-slate-500">Cargando an치lisis de inventario...</p>
      </div>

      <!-- Dashboard Content -->
      <div id="dashboard-content" class="hidden space-y-8">
        <!-- KPI Cards -->
        <section id="kpi-section">
          <h2 class="section-title">
            <i class="fa-solid fa-chart-column"></i>
            Indicadores principales
          </h2>
          <div
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
            id="kpi-grid"
          ></div>
        </section>

        <!-- Charts Row -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Top Proveedores -->
          <div class="card">
            <h3 class="section-title">
              <i class="fa-solid fa-truck"></i>
              Top proveedores por valor
            </h3>
            <div class="h-64">
              <canvas id="suppliers-chart"></canvas>
            </div>
          </div>

          <!-- Categories -->
          <div class="card">
            <h3 class="section-title">
              <i class="fa-solid fa-layer-group"></i>
              Valor por categor칤a
            </h3>
            <div
              id="categories-chart-container"
              class="overflow-y-auto"
              style="height: 280px"
            >
              <canvas id="categories-chart"></canvas>
            </div>
          </div>
        </section>

        <!-- Top Products & Alerts Table -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Top Products by Value -->
          <div class="card">
            <h3 class="section-title">
              <i class="fa-solid fa-coins"></i>
              Top productos por valor
            </h3>
            <div
              class="overflow-x-auto max-h-80 overflow-y-auto"
              id="top-products-table"
            ></div>
          </div>

          <!-- Alerts Table -->
          <div class="card">
            <h3 class="section-title">
              <i class="fa-solid fa-triangle-exclamation text-red-500"></i>
              Productos en alerta
            </h3>
            <div
              class="overflow-x-auto max-h-80 overflow-y-auto"
              id="alerts-table"
            ></div>
          </div>
        </section>

        <!-- Brands Chart -->
        <section class="card">
          <h3 class="section-title">
            <i class="fa-solid fa-tags"></i>
            Top marcas por valor de inventario
          </h3>
          <div class="h-72">
            <canvas id="brands-chart"></canvas>
          </div>
        </section>

        <!-- Estado del Stock -->
        <section id="alerts-section">
          <h2 class="section-title">
            <i class="fa-solid fa-boxes-stacked"></i>
            Estado del stock
          </h2>
          <div class="card" id="stock-status-panel"></div>
        </section>

        <!-- Search Section -->
        <section class="card">
          <h3 class="section-title">
            <i class="fa-solid fa-magnifying-glass"></i>
            B칰squeda de productos
          </h3>
          <div class="flex flex-wrap gap-3 mb-4">
            <input
              type="text"
              id="search-input"
              placeholder="Buscar por SKU, producto..."
              class="flex-1 min-w-[180px] px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-slate-700 placeholder-slate-400 focus:ring-2 focus:ring-[#0c4a6e] focus:border-transparent text-sm"
            />
            <select
              id="filter-category"
              class="px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-slate-700 text-sm"
            >
              <option value="">Todas las categor칤as</option>
            </select>
            <select
              id="filter-status"
              class="px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-slate-700 text-sm"
            >
              <option value="">Todos los estados</option>
              <option value="negative">游댮 Stock Negativo</option>
              <option value="out_of_stock">游 Sin Stock</option>
              <option value="critical">游리 Cr칤tico</option>
              <option value="low">游릭 Bajo</option>
              <option value="optimal">游릭 칍ptimo</option>
              <option value="overstock">游댯 Exceso</option>
            </select>

            <select
              id="items-per-page"
              class="px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-slate-700 text-sm"
            >
              <option value="10">10 por p치gina</option>
              <option value="20" selected>20 por p치gina</option>
              <option value="50">50 por p치gina</option>
              <option value="100">100 por p치gina</option>
            </select>
            <button
              onclick="searchProducts(1)"
              class="px-5 py-2 bg-[#37b6fb] hover:bg-[#1da1e6] rounded-lg text-white font-medium text-sm"
            >
              Buscar
            </button>
          </div>
          <div id="search-results" class="overflow-x-auto"></div>
          <div
            id="pagination-container"
            class="flex justify-between items-center mt-4 hidden"
          >
            <p id="results-info" class="text-sm text-slate-500"></p>
            <div id="pagination-buttons" class="flex gap-2"></div>
          </div>
        </section>
      </div>
    </main>

    <!-- Footer (loaded from partial) -->
    <div id="footer-placeholder"></div>

    <script>
      // Load HTML Partials (DRY - reusable components)
      async function loadPartials() {
        try {
          // Load header
          const headerResponse = await fetch("partials/header.html");
          const headerHtml = await headerResponse.text();
          document.getElementById("header-placeholder").innerHTML = headerHtml;

          // Load footer
          const footerResponse = await fetch("partials/footer.html");
          const footerHtml = await footerResponse.text();
          document.getElementById("footer-placeholder").innerHTML = footerHtml;

          // Set dynamic year
          document.getElementById("current-year").textContent =
            new Date().getFullYear();
        } catch (error) {
          console.error("Error loading partials:", error);
        }
      }

      // API Base URL - Detectar ambiente autom치ticamente
      const isProduction =
        window.location.hostname !== "localhost" &&
        window.location.hostname !== "127.0.0.1";
      const API_URL = isProduction ? "/api" : "http://localhost:5000/api";

      // Chart instances
      let suppliersChart = null;
      let categoriesChart = null;
      let brandsChart = null;

      // Upload Modal Helpers
      function showUploadModal() {
        document.getElementById("upload-modal").classList.remove("hidden");
      }
      function hideUploadModal() {
        document.getElementById("upload-modal").classList.add("hidden");
      }
      function updateUploadProgress(percent, status, title = null) {
        document.getElementById("upload-progress").style.width = percent + "%";
        document.getElementById("upload-percent").textContent = percent + "%";
        document.getElementById("upload-status").textContent = status;
        if (title) document.getElementById("upload-title").textContent = title;
      }

      // Upload Excel file with progress
      async function uploadExcel(event) {
        const file = event.target.files[0];
        if (!file) return;

        showUploadModal();
        updateUploadProgress(0, "Preparando archivo...", "Subiendo archivo...");

        const formData = new FormData();
        formData.append("file", file);

        try {
          // Stage 1: Uploading (0-30%)
          let progress = 0;
          const uploadInterval = setInterval(() => {
            if (progress < 30) {
              progress += 5;
              updateUploadProgress(progress, "Subiendo " + file.name);
            }
          }, 100);

          const response = await fetch(`${API_URL}/upload`, {
            method: "POST",
            body: formData,
          });

          clearInterval(uploadInterval);
          updateUploadProgress(30, "Archivo recibido");

          // Stage 2: Processing (30-70%)
          updateUploadProgress(
            40,
            "Procesando datos...",
            "Procesando Excel...",
          );
          const data = await response.json();

          if (response.ok) {
            updateUploadProgress(70, data.message);

            // Stage 3: Loading dashboard (70-100%)
            updateUploadProgress(
              80,
              "Actualizando dashboard...",
              "Cargando datos...",
            );
            await loadData();
            updateUploadProgress(100, "춰Completado!");

            // Close modal after success
            setTimeout(() => {
              hideUploadModal();
              updateStatus(true, data.message);
            }, 500);
          } else {
            hideUploadModal();
            updateStatus(false, data.error || "Error al cargar");
          }
        } catch (error) {
          console.error("Upload error:", error);
          hideUploadModal();
          updateStatus(false, "Error de conexi칩n");
        }

        // Reset file input
        event.target.value = "";
      }

      // Format currency
      const formatCurrency = (value) => {
        return new Intl.NumberFormat("es-PE", {
          style: "currency",
          currency: "PEN",
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        }).format(value);
      };

      // Format number
      const formatNumber = (value) => {
        return new Intl.NumberFormat("es-PE").format(value);
      };

      // Update status indicator
      function updateStatus(isConnected, message) {
        const dot = document.getElementById("status-dot");
        const text = document.getElementById("status-text");

        if (isConnected) {
          dot.className = "w-2 h-2 rounded-full bg-green-500 animate-pulse";
          text.textContent = message || "Conectado";
          text.className = "text-sm text-green-400";
        } else {
          dot.className = "w-2 h-2 rounded-full bg-red-500";
          text.textContent = message || "Desconectado";
          text.className = "text-sm text-red-400";
        }
      }

      // Load all data
      async function loadData() {
        try {
          document.getElementById("loading-state").classList.remove("hidden");
          document.getElementById("dashboard-content").classList.add("hidden");

          const [
            kpisRes,
            stockStatusRes,
            suppliersRes,
            categoriesRes,
            brandsRes,
            topProductsRes,
            alertsRes,
          ] = await Promise.all([
            fetch(`${API_URL}/kpis`),
            fetch(`${API_URL}/stock-status`),
            fetch(`${API_URL}/suppliers`),
            fetch(`${API_URL}/categories`),
            fetch(`${API_URL}/brands`),
            fetch(`${API_URL}/top-products`),
            fetch(`${API_URL}/alerts`),
          ]);

          if (!kpisRes.ok) throw new Error("API not available");

          const kpis = await kpisRes.json();
          const stockStatus = await stockStatusRes.json();
          const suppliers = await suppliersRes.json();
          const categories = await categoriesRes.json();
          const brands = await brandsRes.json();
          const topProducts = await topProductsRes.json();
          const alerts = await alertsRes.json();

          renderKPIs(kpis);
          renderStockStatus(stockStatus);
          renderSuppliersChart(suppliers);
          renderCategoriesChart(categories);
          renderBrandsChart(brands);
          renderTopProductsTable(topProducts);
          renderAlertsTable(alerts);
          populateCategoryFilter(categories);

          updateStatus(true, `${formatNumber(kpis.total_skus)} productos`);

          document.getElementById("loading-state").classList.add("hidden");
          document
            .getElementById("dashboard-content")
            .classList.remove("hidden");
        } catch (error) {
          console.error("Error loading data:", error);
          updateStatus(false, "Error de conexi칩n");
          document.getElementById("loading-state").innerHTML = `
                    <div class="text-center">
                        <div class="text-6xl mb-4">丘멆잺</div>
                        <h3 class="text-xl font-semibold text-gray-300 mb-2">No se pudo conectar al servidor</h3>
                        <p class="text-slate-500 mb-4">Aseg칰rate de que el servidor Flask est칠 ejecut치ndose en el puerto 5000</p>
                        <button onclick="loadData()" class="px-6 py-2 bg-[#0c4a6e] hover:bg-[#0a3d5c] rounded-lg text-white font-medium">
                            Reintentar
                        </button>
                    </div>
                `;
        }
      }

      // Render KPI Cards
      function renderKPIs(kpis) {
        const grid = document.getElementById("kpi-grid");

        const kpiCards = [
          {
            label: "Valor Total",
            value: formatCurrency(kpis.total_value),
            subtitle: "Inversi칩n en inventario",
            icon: "游눯",
            bg: "bg-emerald-100",
          },
          {
            label: "Total SKUs",
            value: formatNumber(kpis.total_skus),
            subtitle: `${formatNumber(kpis.active_skus)} SKUs con stock`,
            icon: "游닍",
            bg: "bg-blue-100",
          },
          {
            label: "Stock Total",
            value: formatNumber(kpis.total_stock),
            subtitle: `Promedio: ${kpis.avg_stock} uds/SKU`,
            icon: "游늵",
            bg: "bg-purple-100",
          },
          {
            label: "Alertas",
            value: formatNumber(kpis.alerts.total_alerts),
            subtitle: `${formatNumber(kpis.alerts.out_of_stock)} productos sin stock`,
            icon: "丘멆잺",
            bg: "bg-amber-100",
          },
          {
            label: "Diferencias",
            value: formatNumber(kpis.diferencias_count),
            subtitle: `${formatNumber(kpis.diferencias_count)} SKUs afectados`,
            icon: "游댵",
            bg: "bg-red-100",
          },
          {
            label: "Valorizado Negativo",
            value: formatCurrency(Math.abs(kpis.diferencias_value)),
            subtitle: `${formatNumber(Math.abs(kpis.diferencias_units))} unidades`,
            icon: "游눶",
            bg: "bg-rose-100",
          },
        ];

        grid.innerHTML = kpiCards
          .map(
            (kpi) => `
                <div class="card">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="text-xs text-slate-500 mb-1 uppercase tracking-wide">${kpi.label}</p>
                            <p class="text-2xl font-semibold text-[#0c4a6e]">${kpi.value}</p>
                            ${kpi.subtitle ? `<p class="text-xs text-slate-400 mt-1">${kpi.subtitle}</p>` : ""}
                        </div>
                        <div class="w-10 h-10 ${kpi.bg} rounded-lg flex items-center justify-center text-xl">
                            ${kpi.icon}
                        </div>
                    </div>
                </div>
            `,
          )
          .join("");
      }

      // Render Stock Status Panel
      function renderStockStatus(data) {
        const panel = document.getElementById("stock-status-panel");
        const totalProducts = data.reduce((sum, item) => sum + item.count, 0);

        panel.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                    ${data
                      .map(
                        (item) => `
                        <div class="text-center p-3 rounded-lg bg-slate-50 border border-slate-200 cursor-pointer"
                             onclick="filterByStatus('${item.status}')">
                            <div class="text-2xl mb-1">${item.icon}</div>
                            <p class="text-xl font-semibold text-[#0c4a6e]">${formatNumber(item.count)}</p>
                            <p class="text-xs text-slate-500">${item.label}</p>
                            <p class="text-xs font-medium" style="color: ${item.color}">${item.percentage}%</p>
                        </div>
                    `,
                      )
                      .join("")}
                </div>
                <div class="mt-4">
                    <div class="flex h-2 rounded-full overflow-hidden bg-slate-200">
                        ${data
                          .map(
                            (item) => `
                            <div class="status-bar" style="width: ${item.percentage}%; background-color: ${item.color};"
                                 title="${item.label}: ${item.count} productos"></div>
                        `,
                          )
                          .join("")}
                    </div>
                </div>
            `;
      }

      // Render Suppliers Chart
      function renderSuppliersChart(data) {
        const ctx = document.getElementById("suppliers-chart").getContext("2d");

        if (suppliersChart) suppliersChart.destroy();

        // Tomar top 8 proveedores
        const topSuppliers = data.slice(0, 8);

        suppliersChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: topSuppliers.map((d) => d.supplier.substring(0, 15)),
            datasets: [
              {
                label: "Valor (S/)",
                data: topSuppliers.map((d) => d.value),
                backgroundColor: "#0c4a6e",
                borderWidth: 0,
                borderRadius: 6,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: "y",
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: "rgba(15, 23, 42, 0.95)",
                titleColor: "#f8fafc",
                bodyColor: "#e2e8f0",
                borderColor: "rgba(148, 163, 184, 0.2)",
                borderWidth: 1,
                cornerRadius: 8,
                padding: 12,
                callbacks: {
                  label: (context) => {
                    const item = topSuppliers[context.dataIndex];
                    return ` ${formatCurrency(item.value)} - ${item.products} productos`;
                  },
                },
              },
            },
            scales: {
              x: {
                grid: { display: false },
                ticks: {
                  callback: (value) => formatCurrency(value),
                  color: "#64748b",
                },
              },
              y: {
                grid: { display: false },
                ticks: { color: "#334155", font: { size: 11 } },
              },
            },
          },
        });
      }

      // Render Categories Chart
      function renderCategoriesChart(data) {
        const container = document.getElementById("categories-chart-container");

        if (categoriesChart) categoriesChart.destroy();

        // Calculate height based on number of categories (40px per category)
        const allData = data;
        const chartHeight = Math.max(280, allData.length * 40);

        // Create wrapper div to force height for scrolling
        container.innerHTML = `<div style="height: ${chartHeight}px; min-height: ${chartHeight}px;"><canvas id="categories-chart"></canvas></div>`;

        const ctx = document
          .getElementById("categories-chart")
          .getContext("2d");

        categoriesChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: allData.map((d) => d.category.substring(0, 12)),
            datasets: [
              {
                label: "Valor (S/)",
                data: allData.map((d) => d.value),
                backgroundColor: "#f97316",
                borderWidth: 0,
                borderRadius: 6,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: "y",
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: "rgba(15, 23, 42, 0.95)",
                titleColor: "#f8fafc",
                bodyColor: "#e2e8f0",
                borderColor: "rgba(148, 163, 184, 0.2)",
                borderWidth: 1,
                cornerRadius: 8,
                padding: 12,
                titleFont: { weight: "600", size: 13 },
                bodyFont: { size: 12 },
                displayColors: false,
                callbacks: {
                  label: (context) => `Valor: ${formatCurrency(context.raw)}`,
                },
              },
            },
            scales: {
              x: {
                grid: { color: "rgba(203, 213, 225, 0.3)", drawBorder: false },
                ticks: {
                  color: "#94a3b8",
                  font: { size: 11 },
                  callback: (value) => formatCurrency(value),
                },
              },
              y: {
                grid: { display: false },
                ticks: { color: "#64748b", font: { size: 11 } },
              },
            },
          },
        });
      }

      // Render Brands Chart
      function renderBrandsChart(data) {
        const ctx = document.getElementById("brands-chart").getContext("2d");

        if (brandsChart) brandsChart.destroy();

        const topData = data.slice(0, 10);

        brandsChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: topData.map((d) => d.brand.substring(0, 15)),
            datasets: [
              {
                label: "Valor (S/)",
                data: topData.map((d) => d.value),
                backgroundColor: "#22c55e",
                borderWidth: 0,
                borderRadius: 6,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: "rgba(15, 23, 42, 0.95)",
                titleColor: "#f8fafc",
                bodyColor: "#e2e8f0",
                borderColor: "rgba(148, 163, 184, 0.2)",
                borderWidth: 1,
                cornerRadius: 8,
                padding: 12,
                titleFont: { weight: "600", size: 13 },
                bodyFont: { size: 12 },
                displayColors: false,
                callbacks: {
                  label: (context) => `Valor: ${formatCurrency(context.raw)}`,
                },
              },
            },
            scales: {
              x: {
                grid: { display: false },
                ticks: { color: "#64748b", font: { size: 10 } },
              },
              y: {
                grid: { color: "rgba(203, 213, 225, 0.3)", drawBorder: false },
                ticks: {
                  color: "#94a3b8",
                  font: { size: 11 },
                  callback: (value) => formatCurrency(value),
                },
              },
            },
          },
        });
      }

      // Render Top Products Table
      function renderTopProductsTable(data) {
        const container = document.getElementById("top-products-table");

        container.innerHTML = `
                <table class="w-full text-sm">
                    <thead class="text-slate-500 border-b border-slate-200">
                        <tr>
                            <th class="text-left py-2 px-2">Producto</th>
                            <th class="text-right py-2 px-2">Stock</th>
                            <th class="text-right py-2 px-2">Valor</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        ${data
                          .slice(0, 10)
                          .map(
                            (item) => `
                            <tr class="hover:bg-slate-50">
                                <td class="py-2 px-2">
                                    <p class="text-slate-700 truncate max-w-[200px]" title="${item.product}">${item.product}</p>
                                    <p class="text-xs text-slate-400">${item.category}</p>
                                </td>
                                <td class="text-right py-2 px-2 text-slate-600">${formatNumber(item.stock)}</td>
                                <td class="text-right py-2 px-2 text-[#0c4a6e] font-medium">${formatCurrency(item.value)}</td>
                            </tr>
                        `,
                          )
                          .join("")}
                    </tbody>
                </table>
            `;
      }

      // Render Alerts Table
      function renderAlertsTable(data) {
        const container = document.getElementById("alerts-table");

        container.innerHTML = `
                <table class="w-full text-sm">
                    <thead class="text-slate-500 border-b border-slate-200">
                        <tr>
                            <th class="text-left py-2 px-2">Estado</th>
                            <th class="text-left py-2 px-2">Producto</th>
                            <th class="text-right py-2 px-2">Stock</th>
                            <th class="text-right py-2 px-2">Valor</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        ${data
                          .slice(0, 15)
                          .map(
                            (item) => `
                            <tr class="hover:bg-slate-50">
                                <td class="py-2 px-2">
                                    ${getStatusBadge(item.status)}
                                </td>
                                <td class="py-2 px-2">
                                    <p class="text-slate-700 truncate max-w-[180px]" title="${item.product}">${item.product}</p>
                                    <p class="text-xs text-slate-400">${item.category}</p>
                                </td>
                                <td class="text-right py-2 px-2 font-mono ${item.stock < 0 ? "text-red-500" : "text-slate-600"}">${item.stock}</td>
                                <td class="text-right py-2 px-2 text-slate-600">${formatCurrency(item.value)}</td>
                            </tr>
                        `,
                          )
                          .join("")}
                    </tbody>
                </table>
            `;
      }

      // Pagination state
      let currentPage = 1;

      // Get items per page from selector
      function getItemsPerPage() {
        const select = document.getElementById("items-per-page");
        return select ? parseInt(select.value) : 20;
      }

      // Populate category filter
      function populateCategoryFilter(categories) {
        const select = document.getElementById("filter-category");
        select.innerHTML = '<option value="">Todas las categor칤as</option>';
        categories.forEach((cat) => {
          select.innerHTML += `<option value="${cat.category}">${cat.category}</option>`;
        });
      }

      // Search Products with pagination
      async function searchProducts(page = 1) {
        currentPage = page;
        const query = document.getElementById("search-input").value;
        const category = document.getElementById("filter-category").value;
        const status = document.getElementById("filter-status").value;
        const limit = getItemsPerPage();

        try {
          const params = new URLSearchParams();
          if (query) params.append("q", query);
          if (category) params.append("category", category);
          if (status) params.append("status", status);
          params.append("page", page);
          params.append("limit", limit);

          const response = await fetch(`${API_URL}/search?${params}`);
          const data = await response.json();

          renderSearchResults(data);
          renderPagination(data.total);
        } catch (error) {
          console.error("Search error:", error);
        }
      }

      // Render pagination
      function renderPagination(total) {
        const container = document.getElementById("pagination-container");
        const buttonsDiv = document.getElementById("pagination-buttons");
        const infoP = document.getElementById("results-info");

        if (total === 0) {
          container.classList.add("hidden");
          return;
        }

        container.classList.remove("hidden");
        const itemsPerPage = getItemsPerPage();
        const totalPages = Math.ceil(total / itemsPerPage);
        const start = (currentPage - 1) * itemsPerPage + 1;
        const end = Math.min(currentPage * itemsPerPage, total);

        infoP.textContent = `Mostrando ${start}-${end} de ${formatNumber(total)}`;

        let buttons = "";
        buttons += `<button class="pagination-btn" ${currentPage === 1 ? "disabled" : ""} onclick="searchProducts(${currentPage - 1})">Anterior</button>`;

        // Show page numbers
        const maxVisible = 5;
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + maxVisible - 1);

        if (startPage > 1)
          buttons += `<button class="pagination-btn" onclick="searchProducts(1)">1</button>`;
        if (startPage > 2)
          buttons += `<span class="px-2 text-slate-400">...</span>`;

        for (let i = startPage; i <= endPage; i++) {
          buttons += `<button class="pagination-btn ${i === currentPage ? "active" : ""}" onclick="searchProducts(${i})">${i}</button>`;
        }

        if (endPage < totalPages - 1)
          buttons += `<span class="px-2 text-slate-400">...</span>`;
        if (endPage < totalPages)
          buttons += `<button class="pagination-btn" onclick="searchProducts(${totalPages})">${totalPages}</button>`;

        buttons += `<button class="pagination-btn" ${currentPage === totalPages ? "disabled" : ""} onclick="searchProducts(${currentPage + 1})">Siguiente</button>`;

        buttonsDiv.innerHTML = buttons;
      }

      // Render Search Results
      function renderSearchResults(data) {
        const container = document.getElementById("search-results");

        if (data.results.length === 0) {
          container.innerHTML = `
                    <div class="text-center py-8 text-slate-500">
                        <p>No se encontraron productos</p>
                    </div>
                `;
          return;
        }

        container.innerHTML = `
                <p class="text-sm text-slate-500 mb-4">Mostrando ${data.showing} de ${formatNumber(data.total)} productos</p>
                <table class="w-full text-sm">
                    <thead class="text-slate-500 border-b border-slate-200">
                        <tr>
                            <th class="text-left py-2 px-3">Fecha</th>
                            <th class="text-left py-2 px-3">SKU</th>
                            <th class="text-left py-2 px-3">Producto</th>
                            <th class="text-left py-2 px-3">Categor칤a</th>
                            <th class="text-left py-2 px-3">Marca</th>
                            <th class="text-right py-2 px-3">Stock</th>
                            <th class="text-right py-2 px-3">Valor</th>
                            <th class="text-center py-2 px-3">Estado</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        ${data.results
                          .map(
                            (item) => `
                            <tr class="hover:bg-slate-50">
                                <td class="py-2 px-3 text-slate-500 text-xs">${item.created_at || "-"}</td>
                                <td class="py-2 px-3 text-slate-500 font-mono text-xs">${item.sku}</td>
                                <td class="py-2 px-3 text-slate-700 truncate max-w-[200px]" title="${item.product}">${item.product}</td>
                                <td class="py-2 px-3 text-slate-500">${item.category}</td>
                                <td class="py-2 px-3 text-slate-500">${item.brand}</td>
                                <td class="py-2 px-3 text-right ${item.stock < 0 ? "text-red-500" : "text-slate-600"} font-mono">${formatNumber(item.stock)}</td>
                                <td class="py-2 px-3 text-right text-[#0c4a6e] font-medium">${formatCurrency(item.value)}</td>
                                <td class="py-2 px-3 text-center">${getStatusBadge(item.status)}</td>
                            </tr>
                        `,
                          )
                          .join("")}
                    </tbody>
                </table>
            `;
      }

      // Filter by status
      function filterByStatus(status) {
        document.getElementById("filter-status").value = status;
        searchProducts();
      }

      // Helper functions
      function getStatusBadge(status) {
        const badges = {
          negative:
            '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-700">游댮 Negativo</span>',
          out_of_stock:
            '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-orange-100 text-orange-700">游 Sin Stock</span>',
          critical:
            '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-700">游리 Cr칤tico</span>',
          low: '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-lime-100 text-lime-700">游릭 Bajo</span>',
          optimal:
            '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-emerald-100 text-emerald-700">游릭 칍ptimo</span>',
          overstock:
            '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-sky-100 text-sky-700">游댯 Exceso</span>',
        };
        return badges[status] || status;
      }

      function getABCClass(abc) {
        const classes = {
          A: "bg-[#0c4a6e] text-white",
          B: "bg-sky-100 text-sky-700",
          C: "bg-slate-200 text-slate-600",
        };
        return classes[abc] || "bg-slate-200 text-slate-600";
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", async () => {
        await loadPartials(); // Load header and footer partials first

        // Event listener for search input
        document
          .getElementById("search-input")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") searchProducts();
          });

        loadData(); // Then load dashboard data
      });
    </script>
  </body>
</html>
